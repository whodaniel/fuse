"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphAnalyzer = void 0;
class GraphAnalyzer {
    constructor(nodes, edges) {
        this.nodes = nodes;
        this.edges = edges;
        this.adjacencyMatrix = this.buildAdjacencyMatrix();
        this.nodeMetrics = new Map();
    }
    buildAdjacencyMatrix() {
        const n = this.nodes.length;
        const matrix = Array(n).fill(0).map(() => Array(n).fill(0));
        const nodeIndices = new Map(this.nodes.map((node, i) => [node.id, i]));
        this.edges.forEach(edg(e: any) => {
            const sourceIdx = nodeIndices.get(edge.source);
            const targetIdx = nodeIndices.get(edge.target);
            if (sourceIdx !== undefined && targetIdx !== undefined) {
                matrix[sourceIdx][targetIdx] = 1;
                matrix[targetIdx][sourceIdx] = 1; // For undirected graphs
            }
        });
        return matrix;
    }
    calculateDegrees() {
        const degrees = new Map();
        this.nodes.forEach(nod(e: any) => {
            const inDegree = this.edges.filter((e: any) => e.target === node.id).length;
            const outDegree = this.edges.filter((e: any) => e.source === node.id).length;
            degrees.set(node.id, {
                in: inDegree,
                out: outDegree,
                total: inDegree + outDegree
            });
        });
        return degrees;
    }
    calculateBetweennessCentrality() {
        const betweenness = new Map();
        const n = this.nodes.length;
        // Initialize betweenness values
        this.nodes.forEach(nod(e: any) => betweenness.set(node.id, 0));
        // For each pair of nodes
        for (let i = 0; i < n; i++) {
            for (let j = i + 1; j < n; j++) {
                // Find all shortest paths between i and j
                const paths = this.findAllShortestPaths(i, j);
                if (paths.length > 0) {
                    // For each node that appears in the shortest paths
                    const intermediateNodes = new Set(paths.flat());
                    intermediateNodes.delete(i);
                    intermediateNodes.delete(j);
                    intermediateNodes.forEach(nodeIdx => {
                        const nodeId = this.nodes[nodeIdx].id;
                        const pathsThroughNode = paths.filter(path => path.includes(nodeIdx));
                        betweenness.set(nodeId, betweenness.get(nodeId) + pathsThroughNode.length / paths.length);
                    });
                }
            }
        }
        // Normalize values
        const maxBetweenness = Math.max(...betweenness.values());
        if (maxBetweenness > 0) {
            betweenness.forEach((value, key) => {
                betweenness.set(key, value / maxBetweenness);
            });
        }
        return betweenness;
    }
    calculateClosenessCentrality() {
        const closeness = new Map();
        const n = this.nodes.length;
        this.nodes.forEach((node, i) => {
            let totalDistance = 0;
            let reachableNodes = 0;
            // Calculate shortest paths to all other nodes
            for (let j = 0; j < n; j++) {
                if (i !== j) {
                    const distance = this.findShortestPath(i, j).length - 1;
                    if (distance > 0) {
                        totalDistance += distance;
                        reachableNodes++;
                    }
                }
            }
            closeness.set(node.id, reachableNodes > 0 ? reachableNodes / totalDistance : 0);
        });
        return closeness;
    }
    calculatePageRank(damping = 0.85, iterations = 100) {
        const n = this.nodes.length;
        let pageRank = new Map();
        // Initialize PageRank values
        this.nodes.forEach(nod(e: any) => pageRank.set(node.id, 1 / n));
        for (let iter = 0; iter < iterations; iter++) {
            const newRank = new Map();
            this.nodes.forEach((node, i) => {
                let sum = 0;
                const incomingEdges = this.edges.filter((e: any) => e.target === node.id);
                incomingEdges.forEach(edg(e: any) => {
                    const sourceRank = pageRank.get(edge.source) || 0;
                    const sourceDegree = this.edges.filter((e: any) => e.source === edge.source).length;
                    sum += sourceRank / sourceDegree;
                });
                newRank.set(node.id, (1 - damping) / n + damping * sum);
            });
            pageRank = newRank;
        }
        return pageRank;
    }
    detectCommunities() {
        // Implement Louvain method for community detection
        const communities = new Map();
        let currentCommunity = 0;
        const visited = new Set();
        const dfs = (nodeId) => {
            visited.add(nodeId);
            communities.set(nodeId, currentCommunity);
            const neighbors = this.edges
                .filter((e: any) => e.source === nodeId || e.target === nodeId)
                .map((e: any) => e.source === nodeId ? e.target : e.source);
            neighbors.forEach(neighbor => {
                if (!visited.has(neighbor)) {
                    dfs(neighbor);
                }
            });
        };
        this.nodes.forEach(nod(e: any) => {
            if (!visited.has(node.id)) {
                dfs(node.id);
                currentCommunity++;
            }
        });
        return communities;
    }
    findAllShortestPaths(start, end) {
        const paths = [];
        const queue = [{ path: [start], node: start }];
        const shortestLength = this.findShortestPath(start, end).length;
        while (queue.length > 0) {
            const { path, node } = queue.shift();
            if (path.length > shortestLength)
                break;
            if (node === end && path.length === shortestLength) {
                paths.push(path);
                continue;
            }
            for (let i = 0; i < this.adjacencyMatrix[node].length; i++) {
                if (this.adjacencyMatrix[node][i] && !path.includes(i)) {
                    queue.push({
                        path: [...path, i],
                        node: i
                    });
                }
            }
        }
        return paths;
    }
    findShortestPath(start, end) {
        const visited = new Set();
        const queue = [{ path: [start], node: start }];
        while (queue.length > 0) {
            const { path, node } = queue.shift();
            if (node === end)
                return path;
            if (!visited.has(node)) {
                visited.add(node);
                for (let i = 0; i < this.adjacencyMatrix[node].length; i++) {
                    if (this.adjacencyMatrix[node][i] && !visited.has(i)) {
                        queue.push({
                            path: [...path, i],
                            node: i
                        });
                    }
                }
            }
        }
        return [start];
    }
    analyzeGraph() {
        const degrees = this.calculateDegrees();
        const betweenness = this.calculateBetweennessCentrality();
        const closeness = this.calculateClosenessCentrality();
        const pageRank = this.calculatePageRank();
        const communities = this.detectCommunities();
        this.nodes.forEach(nod(e: any) => {
            const degree = degrees.get(node.id);
            this.nodeMetrics.set(node.id, {
                degree: degree?.total || 0,
                inDegree: degree?.in || 0,
                outDegree: degree?.out || 0,
                betweennessCentrality: betweenness.get(node.id) || 0,
                closenessCentrality: closeness.get(node.id) || 0,
                eigenvectorCentrality: 0, // To be implemented
                pageRank: pageRank.get(node.id) || 0,
                clusteringCoefficient: this.calculateLocalClusteringCoefficient(node.id),
                community: communities.get(node.id) || 0
            });
        });
        return this.nodeMetrics;
    }
    calculateLocalClusteringCoefficient(nodeId) {
        const neighbors = this.edges
            .filter((e: any) => e.source === nodeId || e.target === nodeId)
            .map((e: any) => e.source === nodeId ? e.target : e.source);
        if (neighbors.length < 2)
            return 0;
        let connections = 0;
        for (let i = 0; i < neighbors.length; i++) {
            for (let j = i + 1; j < neighbors.length; j++) {
                if (this.edges.some((e: any) => (e.source === neighbors[i] && e.target === neighbors[j]) ||
                    (e.source === neighbors[j] && e.target === neighbors[i]))) {
                    connections++;
                }
            }
        }
        const possibleConnections = (neighbors.length * (neighbors.length - 1)) / 2;
        return connections / possibleConnections;
    }
}
exports.GraphAnalyzer = GraphAnalyzer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JhcGhBbmFseXNpcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkdyYXBoQW5hbHlzaXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBaUJBLE1BQWEsYUFBYTtJQU10QixZQUFZLEtBQWtCLEVBQUUsS0FBa0I7UUFDOUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVPLG9CQUFvQjtRQUN4QixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUM1QixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUQsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXZFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3RCLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9DLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQy9DLElBQUksU0FBUyxLQUFLLFNBQVMsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQ3JELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyx3QkFBd0I7WUFDOUQsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVNLGdCQUFnQjtRQUNuQixNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRTFCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3JFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ3RFLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDakIsRUFBRSxFQUFFLFFBQVE7Z0JBQ1osR0FBRyxFQUFFLFNBQVM7Z0JBQ2QsS0FBSyxFQUFFLFFBQVEsR0FBRyxTQUFTO2FBQzlCLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVNLDhCQUE4QjtRQUNqQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzlCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBRTVCLGdDQUFnQztRQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXhELHlCQUF5QjtRQUN6QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDekIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDN0IsMENBQTBDO2dCQUMxQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQ25CLG1EQUFtRDtvQkFDbkQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztvQkFDaEQsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUM1QixpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBRTVCLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTt3QkFDaEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUM7d0JBQ3RDLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDdEUsV0FBVyxDQUFDLEdBQUcsQ0FDWCxNQUFNLEVBQ04sV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FDbkUsQ0FBQztvQkFDTixDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUM7UUFFRCxtQkFBbUI7UUFDbkIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELElBQUksY0FBYyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3JCLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQy9CLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssR0FBRyxjQUFjLENBQUMsQ0FBQztZQUNqRCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7UUFFRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRU0sNEJBQTRCO1FBQy9CLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDNUIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFFNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDM0IsSUFBSSxhQUFhLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQztZQUV2Qiw4Q0FBOEM7WUFDOUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6QixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFDVixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7b0JBQ3hELElBQUksUUFBUSxHQUFHLENBQUMsRUFBRSxDQUFDO3dCQUNmLGFBQWEsSUFBSSxRQUFRLENBQUM7d0JBQzFCLGNBQWMsRUFBRSxDQUFDO29CQUNyQixDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDO1lBRUQsU0FBUyxDQUFDLEdBQUcsQ0FDVCxJQUFJLENBQUMsRUFBRSxFQUNQLGNBQWMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDMUQsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQztJQUVNLGlCQUFpQixDQUFDLFVBQWtCLElBQUksRUFBRSxhQUFxQixHQUFHO1FBQ3JFLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzVCLElBQUksUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFFekIsNkJBQTZCO1FBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXpELEtBQUssSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxVQUFVLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUMzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBRTFCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMzQixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBQ1osTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFbkUsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDekIsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNsRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztvQkFDN0UsR0FBRyxJQUFJLFVBQVUsR0FBRyxZQUFZLENBQUM7Z0JBQ3JDLENBQUMsQ0FBQyxDQUFDO2dCQUVILE9BQU8sQ0FBQyxHQUFHLENBQ1AsSUFBSSxDQUFDLEVBQUUsRUFDUCxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxHQUFHLEdBQUcsQ0FDcEMsQ0FBQztZQUNOLENBQUMsQ0FBQyxDQUFDO1lBRUgsUUFBUSxHQUFHLE9BQU8sQ0FBQztRQUN2QixDQUFDO1FBRUQsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztJQUVNLGlCQUFpQjtRQUNwQixtREFBbUQ7UUFDbkQsTUFBTSxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM5QixJQUFJLGdCQUFnQixHQUFHLENBQUMsQ0FBQztRQUN6QixNQUFNLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRTFCLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7WUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQixXQUFXLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBRTFDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLO2lCQUN2QixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQztpQkFDdkQsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV6RCxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUN6QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO29CQUN6QixHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2xCLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQztRQUVGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO2dCQUN4QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUNiLGdCQUFnQixFQUFFLENBQUM7WUFDdkIsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQUVPLG9CQUFvQixDQUFDLEtBQWEsRUFBRSxHQUFXO1FBQ25ELE1BQU0sS0FBSyxHQUFlLEVBQUUsQ0FBQztRQUM3QixNQUFNLEtBQUssR0FBdUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ25GLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBRWhFLE9BQU8sS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0QixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUcsQ0FBQztZQUV0QyxJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsY0FBYztnQkFBRSxNQUFNO1lBRXhDLElBQUksSUFBSSxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLGNBQWMsRUFBRSxDQUFDO2dCQUNqRCxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQixTQUFTO1lBQ2IsQ0FBQztZQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6RCxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7b0JBQ3JELEtBQUssQ0FBQyxJQUFJLENBQUM7d0JBQ1AsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxDQUFDO3dCQUNsQixJQUFJLEVBQUUsQ0FBQztxQkFDVixDQUFDLENBQUM7Z0JBQ1AsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLEtBQWEsRUFBRSxHQUFXO1FBQy9DLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDbEMsTUFBTSxLQUFLLEdBQXVDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUVuRixPQUFPLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdEIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFHLENBQUM7WUFFdEMsSUFBSSxJQUFJLEtBQUssR0FBRztnQkFBRSxPQUFPLElBQUksQ0FBQztZQUU5QixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVsQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDekQsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO3dCQUNuRCxLQUFLLENBQUMsSUFBSSxDQUFDOzRCQUNQLElBQUksRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsQ0FBQzs0QkFDbEIsSUFBSSxFQUFFLENBQUM7eUJBQ1YsQ0FBQyxDQUFDO29CQUNQLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFTSxZQUFZO1FBQ2YsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLDhCQUE4QixFQUFFLENBQUM7UUFDMUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixFQUFFLENBQUM7UUFDdEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDMUMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdEIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDMUIsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLElBQUksQ0FBQztnQkFDMUIsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFFLElBQUksQ0FBQztnQkFDekIsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztnQkFDM0IscUJBQXFCLEVBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQztnQkFDcEQsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQztnQkFDaEQscUJBQXFCLEVBQUUsQ0FBQyxFQUFFLG9CQUFvQjtnQkFDOUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUN4RSxTQUFTLEVBQUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQzthQUMzQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUM1QixDQUFDO0lBRU8sbUNBQW1DLENBQUMsTUFBYztRQUN0RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSzthQUN2QixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQzthQUN2RCxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXpELElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxDQUFDLENBQUM7UUFFbkMsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ3BCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDeEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQzVDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDcEIsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEQsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUMzRCxFQUFFLENBQUM7b0JBQ0EsV0FBVyxFQUFFLENBQUM7Z0JBQ2xCLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUVELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1RSxPQUFPLFdBQVcsR0FBRyxtQkFBbUIsQ0FBQztJQUM3QyxDQUFDO0NBQ0o7QUF2UkQsc0NBdVJDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHcmFwaEFuYWx5c2lzIC0gQWR2YW5jZWQgZ3JhcGggYWxnb3JpdGhtcyBmb3IgbmV0d29yayBhbmFseXNpc1xuICovXG5pbXBvcnQgeyBHcmFwaE5vZGUsIEdyYXBoRWRnZSB9IGZyb20gJy4uLy4uL3NoYXJlZC90eXBlcyc7XG5cbmludGVyZmFjZSBOb2RlTWV0cmljcyB7XG4gICAgZGVncmVlOiBudW1iZXI7XG4gICAgaW5EZWdyZWU6IG51bWJlcjtcbiAgICBvdXREZWdyZWU6IG51bWJlcjtcbiAgICBiZXR3ZWVubmVzc0NlbnRyYWxpdHk6IG51bWJlcjtcbiAgICBjbG9zZW5lc3NDZW50cmFsaXR5OiBudW1iZXI7XG4gICAgZWlnZW52ZWN0b3JDZW50cmFsaXR5OiBudW1iZXI7XG4gICAgcGFnZVJhbms6IG51bWJlcjtcbiAgICBjbHVzdGVyaW5nQ29lZmZpY2llbnQ6IG51bWJlcjtcbiAgICBjb21tdW5pdHk6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEdyYXBoQW5hbHl6ZXIge1xuICAgIHByaXZhdGUgbm9kZXM6IEdyYXBoTm9kZVtdO1xuICAgIHByaXZhdGUgZWRnZXM6IEdyYXBoRWRnZVtdO1xuICAgIHByaXZhdGUgYWRqYWNlbmN5TWF0cml4OiBudW1iZXJbXVtdO1xuICAgIHByaXZhdGUgbm9kZU1ldHJpY3M6IE1hcDxzdHJpbmcsIE5vZGVNZXRyaWNzPjtcblxuICAgIGNvbnN0cnVjdG9yKG5vZGVzOiBHcmFwaE5vZGVbXSwgZWRnZXM6IEdyYXBoRWRnZVtdKSB7XG4gICAgICAgIHRoaXMubm9kZXMgPSBub2RlcztcbiAgICAgICAgdGhpcy5lZGdlcyA9IGVkZ2VzO1xuICAgICAgICB0aGlzLmFkamFjZW5jeU1hdHJpeCA9IHRoaXMuYnVpbGRBZGphY2VuY3lNYXRyaXgoKTtcbiAgICAgICAgdGhpcy5ub2RlTWV0cmljcyA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkQWRqYWNlbmN5TWF0cml4KCk6IG51bWJlcltdW10ge1xuICAgICAgICBjb25zdCBuID0gdGhpcy5ub2Rlcy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IG1hdHJpeCA9IEFycmF5KG4pLmZpbGwoMCkubWFwKCgpID0+IEFycmF5KG4pLmZpbGwoMCkpO1xuICAgICAgICBjb25zdCBub2RlSW5kaWNlcyA9IG5ldyBNYXAodGhpcy5ub2Rlcy5tYXAoKG5vZGUsIGkpID0+IFtub2RlLmlkLCBpXSkpO1xuXG4gICAgICAgIHRoaXMuZWRnZXMuZm9yRWFjaChlZGdlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUlkeCA9IG5vZGVJbmRpY2VzLmdldChlZGdlLnNvdXJjZSk7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJZHggPSBub2RlSW5kaWNlcy5nZXQoZWRnZS50YXJnZXQpO1xuICAgICAgICAgICAgaWYgKHNvdXJjZUlkeCAhPT0gdW5kZWZpbmVkICYmIHRhcmdldElkeCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgbWF0cml4W3NvdXJjZUlkeF1bdGFyZ2V0SWR4XSA9IDE7XG4gICAgICAgICAgICAgICAgbWF0cml4W3RhcmdldElkeF1bc291cmNlSWR4XSA9IDE7IC8vIEZvciB1bmRpcmVjdGVkIGdyYXBoc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbWF0cml4O1xuICAgIH1cblxuICAgIHB1YmxpYyBjYWxjdWxhdGVEZWdyZWVzKCk6IE1hcDxzdHJpbmcsIHsgaW46IG51bWJlcjsgb3V0OiBudW1iZXI7IHRvdGFsOiBudW1iZXIgfT4ge1xuICAgICAgICBjb25zdCBkZWdyZWVzID0gbmV3IE1hcCgpO1xuXG4gICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGluRGVncmVlID0gdGhpcy5lZGdlcy5maWx0ZXIoZSA9PiBlLnRhcmdldCA9PT0gbm9kZS5pZCkubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3Qgb3V0RGVncmVlID0gdGhpcy5lZGdlcy5maWx0ZXIoZSA9PiBlLnNvdXJjZSA9PT0gbm9kZS5pZCkubGVuZ3RoO1xuICAgICAgICAgICAgZGVncmVlcy5zZXQobm9kZS5pZCwge1xuICAgICAgICAgICAgICAgIGluOiBpbkRlZ3JlZSxcbiAgICAgICAgICAgICAgICBvdXQ6IG91dERlZ3JlZSxcbiAgICAgICAgICAgICAgICB0b3RhbDogaW5EZWdyZWUgKyBvdXREZWdyZWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZGVncmVlcztcbiAgICB9XG5cbiAgICBwdWJsaWMgY2FsY3VsYXRlQmV0d2Vlbm5lc3NDZW50cmFsaXR5KCk6IE1hcDxzdHJpbmcsIG51bWJlcj4ge1xuICAgICAgICBjb25zdCBiZXR3ZWVubmVzcyA9IG5ldyBNYXAoKTtcbiAgICAgICAgY29uc3QgbiA9IHRoaXMubm9kZXMubGVuZ3RoO1xuICAgICAgICBcbiAgICAgICAgLy8gSW5pdGlhbGl6ZSBiZXR3ZWVubmVzcyB2YWx1ZXNcbiAgICAgICAgdGhpcy5ub2Rlcy5mb3JFYWNoKG5vZGUgPT4gYmV0d2Vlbm5lc3Muc2V0KG5vZGUuaWQsIDApKTtcblxuICAgICAgICAvLyBGb3IgZWFjaCBwYWlyIG9mIG5vZGVzXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBuOyBqKyspIHtcbiAgICAgICAgICAgICAgICAvLyBGaW5kIGFsbCBzaG9ydGVzdCBwYXRocyBiZXR3ZWVuIGkgYW5kIGpcbiAgICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IHRoaXMuZmluZEFsbFNob3J0ZXN0UGF0aHMoaSwgaik7XG4gICAgICAgICAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGVhY2ggbm9kZSB0aGF0IGFwcGVhcnMgaW4gdGhlIHNob3J0ZXN0IHBhdGhzXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVybWVkaWF0ZU5vZGVzID0gbmV3IFNldChwYXRocy5mbGF0KCkpO1xuICAgICAgICAgICAgICAgICAgICBpbnRlcm1lZGlhdGVOb2Rlcy5kZWxldGUoaSk7XG4gICAgICAgICAgICAgICAgICAgIGludGVybWVkaWF0ZU5vZGVzLmRlbGV0ZShqKTtcblxuICAgICAgICAgICAgICAgICAgICBpbnRlcm1lZGlhdGVOb2Rlcy5mb3JFYWNoKG5vZGVJZHggPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9kZUlkID0gdGhpcy5ub2Rlc1tub2RlSWR4XS5pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdGhzVGhyb3VnaE5vZGUgPSBwYXRocy5maWx0ZXIocGF0aCA9PiBwYXRoLmluY2x1ZGVzKG5vZGVJZHgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJldHdlZW5uZXNzLnNldChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmV0d2Vlbm5lc3MuZ2V0KG5vZGVJZCkgKyBwYXRoc1Rocm91Z2hOb2RlLmxlbmd0aCAvIHBhdGhzLmxlbmd0aFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gTm9ybWFsaXplIHZhbHVlc1xuICAgICAgICBjb25zdCBtYXhCZXR3ZWVubmVzcyA9IE1hdGgubWF4KC4uLmJldHdlZW5uZXNzLnZhbHVlcygpKTtcbiAgICAgICAgaWYgKG1heEJldHdlZW5uZXNzID4gMCkge1xuICAgICAgICAgICAgYmV0d2Vlbm5lc3MuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGJldHdlZW5uZXNzLnNldChrZXksIHZhbHVlIC8gbWF4QmV0d2Vlbm5lc3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYmV0d2Vlbm5lc3M7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbGN1bGF0ZUNsb3NlbmVzc0NlbnRyYWxpdHkoKTogTWFwPHN0cmluZywgbnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGNsb3NlbmVzcyA9IG5ldyBNYXAoKTtcbiAgICAgICAgY29uc3QgbiA9IHRoaXMubm9kZXMubGVuZ3RoO1xuXG4gICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaCgobm9kZSwgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHRvdGFsRGlzdGFuY2UgPSAwO1xuICAgICAgICAgICAgbGV0IHJlYWNoYWJsZU5vZGVzID0gMDtcblxuICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHNob3J0ZXN0IHBhdGhzIHRvIGFsbCBvdGhlciBub2Rlc1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBuOyBqKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoaSAhPT0gaikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaXN0YW5jZSA9IHRoaXMuZmluZFNob3J0ZXN0UGF0aChpLCBqKS5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbERpc3RhbmNlICs9IGRpc3RhbmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVhY2hhYmxlTm9kZXMrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2xvc2VuZXNzLnNldChcbiAgICAgICAgICAgICAgICBub2RlLmlkLFxuICAgICAgICAgICAgICAgIHJlYWNoYWJsZU5vZGVzID4gMCA/IHJlYWNoYWJsZU5vZGVzIC8gdG90YWxEaXN0YW5jZSA6IDBcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBjbG9zZW5lc3M7XG4gICAgfVxuXG4gICAgcHVibGljIGNhbGN1bGF0ZVBhZ2VSYW5rKGRhbXBpbmc6IG51bWJlciA9IDAuODUsIGl0ZXJhdGlvbnM6IG51bWJlciA9IDEwMCk6IE1hcDxzdHJpbmcsIG51bWJlcj4ge1xuICAgICAgICBjb25zdCBuID0gdGhpcy5ub2Rlcy5sZW5ndGg7XG4gICAgICAgIGxldCBwYWdlUmFuayA9IG5ldyBNYXAoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEluaXRpYWxpemUgUGFnZVJhbmsgdmFsdWVzXG4gICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChub2RlID0+IHBhZ2VSYW5rLnNldChub2RlLmlkLCAxIC8gbikpO1xuXG4gICAgICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgaXRlcmF0aW9uczsgaXRlcisrKSB7XG4gICAgICAgICAgICBjb25zdCBuZXdSYW5rID0gbmV3IE1hcCgpO1xuXG4gICAgICAgICAgICB0aGlzLm5vZGVzLmZvckVhY2goKG5vZGUsIGkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc3VtID0gMDtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmNvbWluZ0VkZ2VzID0gdGhpcy5lZGdlcy5maWx0ZXIoZSA9PiBlLnRhcmdldCA9PT0gbm9kZS5pZCk7XG5cbiAgICAgICAgICAgICAgICBpbmNvbWluZ0VkZ2VzLmZvckVhY2goZWRnZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZVJhbmsgPSBwYWdlUmFuay5nZXQoZWRnZS5zb3VyY2UpIHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZURlZ3JlZSA9IHRoaXMuZWRnZXMuZmlsdGVyKGUgPT4gZS5zb3VyY2UgPT09IGVkZ2Uuc291cmNlKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIHN1bSArPSBzb3VyY2VSYW5rIC8gc291cmNlRGVncmVlO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgbmV3UmFuay5zZXQoXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuaWQsXG4gICAgICAgICAgICAgICAgICAgICgxIC0gZGFtcGluZykgLyBuICsgZGFtcGluZyAqIHN1bVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcGFnZVJhbmsgPSBuZXdSYW5rO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBhZ2VSYW5rO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZXRlY3RDb21tdW5pdGllcygpOiBNYXA8c3RyaW5nLCBudW1iZXI+IHtcbiAgICAgICAgLy8gSW1wbGVtZW50IExvdXZhaW4gbWV0aG9kIGZvciBjb21tdW5pdHkgZGV0ZWN0aW9uXG4gICAgICAgIGNvbnN0IGNvbW11bml0aWVzID0gbmV3IE1hcCgpO1xuICAgICAgICBsZXQgY3VycmVudENvbW11bml0eSA9IDA7XG4gICAgICAgIGNvbnN0IHZpc2l0ZWQgPSBuZXcgU2V0KCk7XG5cbiAgICAgICAgY29uc3QgZGZzID0gKG5vZGVJZDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICB2aXNpdGVkLmFkZChub2RlSWQpO1xuICAgICAgICAgICAgY29tbXVuaXRpZXMuc2V0KG5vZGVJZCwgY3VycmVudENvbW11bml0eSk7XG5cbiAgICAgICAgICAgIGNvbnN0IG5laWdoYm9ycyA9IHRoaXMuZWRnZXNcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGUgPT4gZS5zb3VyY2UgPT09IG5vZGVJZCB8fCBlLnRhcmdldCA9PT0gbm9kZUlkKVxuICAgICAgICAgICAgICAgIC5tYXAoZSA9PiBlLnNvdXJjZSA9PT0gbm9kZUlkID8gZS50YXJnZXQgOiBlLnNvdXJjZSk7XG5cbiAgICAgICAgICAgIG5laWdoYm9ycy5mb3JFYWNoKG5laWdoYm9yID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXZpc2l0ZWQuaGFzKG5laWdoYm9yKSkge1xuICAgICAgICAgICAgICAgICAgICBkZnMobmVpZ2hib3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMubm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgICAgIGlmICghdmlzaXRlZC5oYXMobm9kZS5pZCkpIHtcbiAgICAgICAgICAgICAgICBkZnMobm9kZS5pZCk7XG4gICAgICAgICAgICAgICAgY3VycmVudENvbW11bml0eSsrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gY29tbXVuaXRpZXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaW5kQWxsU2hvcnRlc3RQYXRocyhzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlcik6IG51bWJlcltdW10ge1xuICAgICAgICBjb25zdCBwYXRoczogbnVtYmVyW11bXSA9IFtdO1xuICAgICAgICBjb25zdCBxdWV1ZTogeyBwYXRoOiBudW1iZXJbXTsgbm9kZTogbnVtYmVyIH1bXSA9IFt7IHBhdGg6IFtzdGFydF0sIG5vZGU6IHN0YXJ0IH1dO1xuICAgICAgICBjb25zdCBzaG9ydGVzdExlbmd0aCA9IHRoaXMuZmluZFNob3J0ZXN0UGF0aChzdGFydCwgZW5kKS5sZW5ndGg7XG5cbiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcGF0aCwgbm9kZSB9ID0gcXVldWUuc2hpZnQoKSE7XG5cbiAgICAgICAgICAgIGlmIChwYXRoLmxlbmd0aCA+IHNob3J0ZXN0TGVuZ3RoKSBicmVhaztcblxuICAgICAgICAgICAgaWYgKG5vZGUgPT09IGVuZCAmJiBwYXRoLmxlbmd0aCA9PT0gc2hvcnRlc3RMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYWRqYWNlbmN5TWF0cml4W25vZGVdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYWRqYWNlbmN5TWF0cml4W25vZGVdW2ldICYmICFwYXRoLmluY2x1ZGVzKGkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogWy4uLnBhdGgsIGldLFxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogaVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGF0aHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmaW5kU2hvcnRlc3RQYXRoKHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyKTogbnVtYmVyW10ge1xuICAgICAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldDxudW1iZXI+KCk7XG4gICAgICAgIGNvbnN0IHF1ZXVlOiB7IHBhdGg6IG51bWJlcltdOyBub2RlOiBudW1iZXIgfVtdID0gW3sgcGF0aDogW3N0YXJ0XSwgbm9kZTogc3RhcnQgfV07XG5cbiAgICAgICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcGF0aCwgbm9kZSB9ID0gcXVldWUuc2hpZnQoKSE7XG5cbiAgICAgICAgICAgIGlmIChub2RlID09PSBlbmQpIHJldHVybiBwYXRoO1xuXG4gICAgICAgICAgICBpZiAoIXZpc2l0ZWQuaGFzKG5vZGUpKSB7XG4gICAgICAgICAgICAgICAgdmlzaXRlZC5hZGQobm9kZSk7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYWRqYWNlbmN5TWF0cml4W25vZGVdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmFkamFjZW5jeU1hdHJpeFtub2RlXVtpXSAmJiAhdmlzaXRlZC5oYXMoaSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IFsuLi5wYXRoLCBpXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBpXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBbc3RhcnRdO1xuICAgIH1cblxuICAgIHB1YmxpYyBhbmFseXplR3JhcGgoKTogTWFwPHN0cmluZywgTm9kZU1ldHJpY3M+IHtcbiAgICAgICAgY29uc3QgZGVncmVlcyA9IHRoaXMuY2FsY3VsYXRlRGVncmVlcygpO1xuICAgICAgICBjb25zdCBiZXR3ZWVubmVzcyA9IHRoaXMuY2FsY3VsYXRlQmV0d2Vlbm5lc3NDZW50cmFsaXR5KCk7XG4gICAgICAgIGNvbnN0IGNsb3NlbmVzcyA9IHRoaXMuY2FsY3VsYXRlQ2xvc2VuZXNzQ2VudHJhbGl0eSgpO1xuICAgICAgICBjb25zdCBwYWdlUmFuayA9IHRoaXMuY2FsY3VsYXRlUGFnZVJhbmsoKTtcbiAgICAgICAgY29uc3QgY29tbXVuaXRpZXMgPSB0aGlzLmRldGVjdENvbW11bml0aWVzKCk7XG5cbiAgICAgICAgdGhpcy5ub2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgZGVncmVlID0gZGVncmVlcy5nZXQobm9kZS5pZCk7XG4gICAgICAgICAgICB0aGlzLm5vZGVNZXRyaWNzLnNldChub2RlLmlkLCB7XG4gICAgICAgICAgICAgICAgZGVncmVlOiBkZWdyZWU/LnRvdGFsIHx8IDAsXG4gICAgICAgICAgICAgICAgaW5EZWdyZWU6IGRlZ3JlZT8uaW4gfHwgMCxcbiAgICAgICAgICAgICAgICBvdXREZWdyZWU6IGRlZ3JlZT8ub3V0IHx8IDAsXG4gICAgICAgICAgICAgICAgYmV0d2Vlbm5lc3NDZW50cmFsaXR5OiBiZXR3ZWVubmVzcy5nZXQobm9kZS5pZCkgfHwgMCxcbiAgICAgICAgICAgICAgICBjbG9zZW5lc3NDZW50cmFsaXR5OiBjbG9zZW5lc3MuZ2V0KG5vZGUuaWQpIHx8IDAsXG4gICAgICAgICAgICAgICAgZWlnZW52ZWN0b3JDZW50cmFsaXR5OiAwLCAvLyBUbyBiZSBpbXBsZW1lbnRlZFxuICAgICAgICAgICAgICAgIHBhZ2VSYW5rOiBwYWdlUmFuay5nZXQobm9kZS5pZCkgfHwgMCxcbiAgICAgICAgICAgICAgICBjbHVzdGVyaW5nQ29lZmZpY2llbnQ6IHRoaXMuY2FsY3VsYXRlTG9jYWxDbHVzdGVyaW5nQ29lZmZpY2llbnQobm9kZS5pZCksXG4gICAgICAgICAgICAgICAgY29tbXVuaXR5OiBjb21tdW5pdGllcy5nZXQobm9kZS5pZCkgfHwgMFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLm5vZGVNZXRyaWNzO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsY3VsYXRlTG9jYWxDbHVzdGVyaW5nQ29lZmZpY2llbnQobm9kZUlkOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBuZWlnaGJvcnMgPSB0aGlzLmVkZ2VzXG4gICAgICAgICAgICAuZmlsdGVyKGUgPT4gZS5zb3VyY2UgPT09IG5vZGVJZCB8fCBlLnRhcmdldCA9PT0gbm9kZUlkKVxuICAgICAgICAgICAgLm1hcChlID0+IGUuc291cmNlID09PSBub2RlSWQgPyBlLnRhcmdldCA6IGUuc291cmNlKTtcblxuICAgICAgICBpZiAobmVpZ2hib3JzLmxlbmd0aCA8IDIpIHJldHVybiAwO1xuXG4gICAgICAgIGxldCBjb25uZWN0aW9ucyA9IDA7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmVpZ2hib3JzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBuZWlnaGJvcnMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lZGdlcy5zb21lKGUgPT5cbiAgICAgICAgICAgICAgICAgICAgKGUuc291cmNlID09PSBuZWlnaGJvcnNbaV0gJiYgZS50YXJnZXQgPT09IG5laWdoYm9yc1tqXSkgfHxcbiAgICAgICAgICAgICAgICAgICAgKGUuc291cmNlID09PSBuZWlnaGJvcnNbal0gJiYgZS50YXJnZXQgPT09IG5laWdoYm9yc1tpXSlcbiAgICAgICAgICAgICAgICApKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25zKys7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcG9zc2libGVDb25uZWN0aW9ucyA9IChuZWlnaGJvcnMubGVuZ3RoICogKG5laWdoYm9ycy5sZW5ndGggLSAxKSkgLyAyO1xuICAgICAgICByZXR1cm4gY29ubmVjdGlvbnMgLyBwb3NzaWJsZUNvbm5lY3Rpb25zO1xuICAgIH1cbn1cbiJdfQ==
export {};
