"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.marketplaceManager = void 0;
class MarketplaceManager {
    constructor() {
        this.agents = [];
        this.currentFilters = {
            categories: [],
            priceRanges: [],
            minRating: 0,
            tags: []
        };
        this.initializeEventListeners();
    }
    static getInstance() {
        if (!MarketplaceManager.instance) {
            MarketplaceManager.instance = new MarketplaceManager();
        }
        return MarketplaceManager.instance;
    }
    initializeEventListeners() {
        // Search input handler
        const searchInput = document.querySelector('.search-input');
        searchInput?.addEventListener('input', this.debounce(() => {
            this.searchAgents(searchInput.value);
        }, 300));
        // Filter checkbox handlers
        document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.updateFilters();
            });
        });
        // Sort handler
        const sortButton = document.querySelector('button:contains("Sort By")');
        sortButton?.addEventListener('click', () => {
            this.showSortOptions();
        });
    }
    debounce(func, wait) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    async loadAgents() {
        try {
            const response = await fetch('/api/marketplace/agents');
            if (!response.ok)
                throw new Error('Failed to load agents');
            this.agents = await response.json();
            this.renderAgents(this.agents);
        }
        catch (error) {
            console.error('Error loading agents:', error);
            this.showError('Failed to load marketplace agents');
        }
    }
    async searchAgents(query) {
        try {
            const response = await fetch(`/api/marketplace/search?q=${encodeURIComponent(query)}`);
            if (!response.ok)
                throw new Error('Search failed');
            const results = await response.json();
            this.renderAgents(results);
        }
        catch (error) {
            console.error('Search error:', error);
            this.showError('Search failed. Please try again.');
        }
    }
    updateFilters() {
        const newFilters = {
            categories: [],
            priceRanges: [],
            minRating: 0,
            tags: []
        };
        // Collect selected categories
        document.querySelectorAll('[data-filter="category"]:checked').forEach(checkbox => {
            newFilters.categories.push(checkbox.value);
        });
        // Collect price ranges
        document.querySelectorAll('[data-filter="price"]:checked').forEach(checkbox => {
            const [min, max] = checkbox.value.split('-');
            newFilters.priceRanges.push({
                min: parseFloat(min),
                max: max === 'inf' ? Infinity : parseFloat(max)
            });
        });
        // Get minimum rating
        const ratingFilter = document.querySelector('[data-filter="rating"]:checked');
        if (ratingFilter) {
            newFilters.minRating = parseInt(ratingFilter.value);
        }
        this.currentFilters = newFilters;
        this.applyFilters();
    }
    applyFilters() {
        const filteredAgents = this.agents.filter(agent => {
            // Category filter
            if (this.currentFilters.categories.length &&
                !this.currentFilters.categories.includes(agent.category)) {
                return false;
            }
            // Price range filter
            if (this.currentFilters.priceRanges.length) {
                const priceMatch = this.currentFilters.priceRanges.some(rang(e: any) => agent.price >= range.min && agent.price <= range.max);
                if (!priceMatch)
                    return false;
            }
            // Rating filter
            if (this.currentFilters.minRating > 0 &&
                agent.rating.average < this.currentFilters.minRating) {
                return false;
            }
            // Tag filter
            if (this.currentFilters.tags.length) {
                const agentTags = agent.tags.map(t => t.id);
                const hasAllTags = this.currentFilters.tags.every(tag => agentTags.includes(tag));
                if (!hasAllTags)
                    return false;
            }
            return true;
        });
        this.renderAgents(filteredAgents);
    }
    renderAgents(agents) {
        const container = document.querySelector('.marketplace-grid');
        if (!container)
            return;
        container.innerHTML = agents.map(agent => this.createAgentCard(agent)).join('');
    }
    createAgentCard(agent) {
        return `
            <div class="agent-card" data-agent-id="${agent.id}">
                <div class="relative">
                    <div class="agent-image" style="background-image: url(${agent.image})"></div>
                    <span class="price-tag">$${agent.price.toFixed(2)}</span>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-900">${agent.name}</h3>
                        <div class="rating-stars">
                            ${this.generateStars(agent.rating.average)}
                        </div>
                    </div>
                    <p class="text-gray-600">${agent.description}</p>
                    <div class="flex flex-wrap gap-2">
                        ${agent.tags.map(tag => `
                            <span class="tag tag-${tag.type}">${tag.name}</span>
                        `).join('')}
                    </div>
                    <button class="w-full btn bg-blue-600 text-white hover:bg-blue-700">
                        View Details
                    </button>
                </div>
            </div>
        `;
    }
    generateStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        return '★'.repeat(fullStars) +
            (hasHalfStar ? '½' : '') +
            '☆'.repeat(emptyStars);
    }
    showSortOptions() {
        const sortOptions = [
            { label: 'Most Popular', value: 'popular' },
            { label: 'Highest Rated', value: 'rating' },
            { label: 'Newest', value: 'newest' },
            { label: 'Price: Low to High', value: 'price_asc' },
            { label: 'Price: High to Low', value: 'price_desc' }
        ];
        const menu = document.createElement('div');
        menu.className = 'absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5';
        menu.innerHTML = `
            <div class="py-1" role="menu">
                ${sortOptions.map(option => `
                    <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" 
                            role="menuitem" 
                            data-sort="${option.value}">
                        ${option.label}
                    </button>
                `).join('')}
            </div>
        `;
        document.body.appendChild(menu);
        // Handle option selection
        menu.addEventListener('click', (e) => {
            const target = e.target;
            if (target.hasAttribute('data-sort')) {
                this.sortAgents(target.getAttribute('data-sort'));
                menu.remove();
            }
        });
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!menu.contains(e.target)) {
                menu.remove();
            }
        }, { once: true });
    }
    sortAgents(sortBy) {
        const sortedAgents = [...this.agents].sort((a, b) => {
            switch (sortBy) {
                case 'popular':
                    return b.stats.downloads - a.stats.downloads;
                case 'rating':
                    return b.rating.average - a.rating.average;
                case 'newest':
                    return new Date(b.id).getTime() - new Date(a.id).getTime();
                case 'price_asc':
                    return a.price - b.price;
                case 'price_desc':
                    return b.price - a.price;
                default:
                    return 0;
            }
        });
        this.renderAgents(sortedAgents);
    }
    showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded';
        errorDiv.role = 'alert';
        errorDiv.innerHTML = message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }
}
// Initialize marketplace manager
const marketplaceManager = MarketplaceManager.getInstance();
exports.marketplaceManager = marketplaceManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2V0cGxhY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtYXJrZXRwbGFjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFpREEsTUFBTSxrQkFBa0I7SUFVcEI7UUFSUSxXQUFNLEdBQXVCLEVBQUUsQ0FBQztRQUNoQyxtQkFBYyxHQUFrQjtZQUNwQyxVQUFVLEVBQUUsRUFBRTtZQUNkLFdBQVcsRUFBRSxFQUFFO1lBQ2YsU0FBUyxFQUFFLENBQUM7WUFDWixJQUFJLEVBQUUsRUFBRTtTQUNYLENBQUM7UUFHRSxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRU0sTUFBTSxDQUFDLFdBQVc7UUFDckIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQy9CLGtCQUFrQixDQUFDLFFBQVEsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7UUFDM0QsQ0FBQztRQUNELE9BQU8sa0JBQWtCLENBQUMsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7SUFFTyx3QkFBd0I7UUFDNUIsdUJBQXVCO1FBQ3ZCLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFxQixDQUFDO1FBQ2hGLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFVCwyQkFBMkI7UUFDM0IsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzdELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO2dCQUNyQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUM7UUFD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UyxHQUFHLHFGQUFxRixDQUFDO1FBQzNHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO1FBQ3hCLFFBQVEsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO1FBRTdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztDQUNKO0FBRUQsaUNBQWlDO0FBQ2pDLE1BQU0sa0JBQWtCLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUM7QUFHbkQsZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW50ZXJmYWNlIEFnZW50VGFnIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB0eXBlOiAnYWknIHwgJ3dvcmtmbG93JyB8ICd0b29sJztcbn1cblxuaW50ZXJmYWNlIEFnZW50UmF0aW5nIHtcbiAgICBhdmVyYWdlOiBudW1iZXI7XG4gICAgY291bnQ6IG51bWJlcjtcbiAgICBkaXN0cmlidXRpb246IHtcbiAgICAgICAgMTogbnVtYmVyO1xuICAgICAgICAyOiBudW1iZXI7XG4gICAgICAgIDM6IG51bWJlcjtcbiAgICAgICAgNDogbnVtYmVyO1xuICAgICAgICA1OiBudW1iZXI7XG4gICAgfTtcbn1cblxuaW50ZXJmYWNlIE1hcmtldHBsYWNlQWdlbnQge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgcHJpY2U6IG51bWJlcjtcbiAgICBpbWFnZTogc3RyaW5nO1xuICAgIHRhZ3M6IEFnZW50VGFnW107XG4gICAgcmF0aW5nOiBBZ2VudFJhdGluZztcbiAgICBjYXRlZ29yeTogc3RyaW5nO1xuICAgIGNyZWF0b3I6IHtcbiAgICAgICAgaWQ6IHN0cmluZztcbiAgICAgICAgbmFtZTogc3RyaW5nO1xuICAgICAgICBhdmF0YXI6IHN0cmluZztcbiAgICB9O1xuICAgIHN0YXRzOiB7XG4gICAgICAgIGRvd25sb2FkczogbnVtYmVyO1xuICAgICAgICB2aWV3czogbnVtYmVyO1xuICAgICAgICBkZXBsb3ltZW50czogbnVtYmVyO1xuICAgIH07XG59XG5cbmludGVyZmFjZSBGaWx0ZXJPcHRpb25zIHtcbiAgICBjYXRlZ29yaWVzOiBzdHJpbmdbXTtcbiAgICBwcmljZVJhbmdlczoge1xuICAgICAgICBtaW46IG51bWJlcjtcbiAgICAgICAgbWF4OiBudW1iZXI7XG4gICAgfVtdO1xuICAgIG1pblJhdGluZzogbnVtYmVyO1xuICAgIHRhZ3M6IHN0cmluZ1tdO1xufVxuXG5jbGFzcyBNYXJrZXRwbGFjZU1hbmFnZXIge1xuICAgIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBNYXJrZXRwbGFjZU1hbmFnZXI7XG4gICAgcHJpdmF0ZSBhZ2VudHM6IE1hcmtldHBsYWNlQWdlbnRbXSA9IFtdO1xuICAgIHByaXZhdGUgY3VycmVudEZpbHRlcnM6IEZpbHRlck9wdGlvbnMgPSB7XG4gICAgICAgIGNhdGVnb3JpZXM6IFtdLFxuICAgICAgICBwcmljZVJhbmdlczogW10sXG4gICAgICAgIG1pblJhdGluZzogMCxcbiAgICAgICAgdGFnczogW11cbiAgICB9O1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGdldEluc3RhbmNlKCk6IE1hcmtldHBsYWNlTWFuYWdlciB7XG4gICAgICAgIGlmICghTWFya2V0cGxhY2VNYW5hZ2VyLmluc3RhbmNlKSB7XG4gICAgICAgICAgICBNYXJrZXRwbGFjZU1hbmFnZXIuaW5zdGFuY2UgPSBuZXcgTWFya2V0cGxhY2VNYW5hZ2VyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIE1hcmtldHBsYWNlTWFuYWdlci5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRpYWxpemVFdmVudExpc3RlbmVycygpOiB2b2lkIHtcbiAgICAgICAgLy8gU2VhcmNoIGlucHV0IGhhbmRsZXJcbiAgICAgICAgY29uc3Qgc2VhcmNoSW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2VhcmNoLWlucHV0JykgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICAgICAgc2VhcmNoSW5wdXQ/LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdGhpcy5kZWJvdW5jZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlYXJjaEFnZW50cyhzZWFyY2hJbnB1dC52YWx1ZSk7XG4gICAgICAgIH0sIDMwMCkpO1xuXG4gICAgICAgIC8vIEZpbHRlciBjaGVja2JveCBoYW5kbGVyc1xuICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuZmlsdGVyLWNoZWNrYm94JykuZm9yRWFjaChjaGVja2JveCA9PiB7XG4gICAgICAgICAgICBjaGVja2JveC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVGaWx0ZXJzKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU29ydCBoYW5kbGVyXG4gICAgICAgIGNvbnN0IHNvcnRCdXR0b24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdidXR0b246Y29udGFpbnMoXCJTb3J0IEJ5XCIpJyk7XG4gICAgICAgIHNvcnRCdXR0b24/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zaG93U29ydE9wdGlvbnMoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWJvdW5jZShmdW5jOiBGdW5jdGlvbiwgd2FpdDogbnVtYmVyKTogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkIHtcbiAgICAgICAgbGV0IHRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0O1xuICAgICAgICByZXR1cm4gKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpLCB3YWl0KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgbG9hZEFnZW50cygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goJy9hcGkvbWFya2V0cGxhY2UvYWdlbnRzJyk7XG4gICAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIGFnZW50cycpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmFnZW50cyA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyQWdlbnRzKHRoaXMuYWdlbnRzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGxvYWRpbmcgYWdlbnRzOicsIGVycm9yKTtcbiAgICAgICAgICAgIHRoaXMuc2hvd0Vycm9yKCdGYWlsZWQgdG8gbG9hZCBtYXJrZXRwbGFjZSBhZ2VudHMnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgc2VhcmNoQWdlbnRzKHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYC9hcGkvbWFya2V0cGxhY2Uvc2VhcmNoP3E9JHtlbmNvZGVVUklDb21wb25lbnQocXVlcnkpfWApO1xuICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykgdGhyb3cgbmV3IEVycm9yKCdTZWFyY2ggZmFpbGVkJyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckFnZW50cyhyZXN1bHRzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1NlYXJjaCBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgICAgICB0aGlzLnNob3dFcnJvcignU2VhcmNoIGZhaWxlZC4gUGxlYXNlIHRyeSBhZ2Fpbi4nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlRmlsdGVycygpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbmV3RmlsdGVyczogRmlsdGVyT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIGNhdGVnb3JpZXM6IFtdLFxuICAgICAgICAgICAgcHJpY2VSYW5nZXM6IFtdLFxuICAgICAgICAgICAgbWluUmF0aW5nOiAwLFxuICAgICAgICAgICAgdGFnczogW11cbiAgICAgICAgfTtcblxuICAgICAgICAvLyBDb2xsZWN0IHNlbGVjdGVkIGNhdGVnb3JpZXNcbiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtZmlsdGVyPVwiY2F0ZWdvcnlcIl06Y2hlY2tlZCcpLmZvckVhY2goY2hlY2tib3ggPT4ge1xuICAgICAgICAgICAgbmV3RmlsdGVycy5jYXRlZ29yaWVzLnB1c2goKGNoZWNrYm94IGFzIEhUTUxJbnB1dEVsZW1lbnQpLnZhbHVlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gQ29sbGVjdCBwcmljZSByYW5nZXNcbiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtZmlsdGVyPVwicHJpY2VcIl06Y2hlY2tlZCcpLmZvckVhY2goY2hlY2tib3ggPT4ge1xuICAgICAgICAgICAgY29uc3QgW21pbiwgbWF4XSA9IChjaGVja2JveCBhcyBIVE1MSW5wdXRFbGVtZW50KS52YWx1ZS5zcGxpdCgnLScpO1xuICAgICAgICAgICAgbmV3RmlsdGVycy5wcmljZVJhbmdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBtaW46IHBhcnNlRmxvYXQobWluKSxcbiAgICAgICAgICAgICAgICBtYXg6IG1heCA9PT0gJ2luZicgPyBJbmZpbml0eSA6IHBhcnNlRmxvYXQobWF4KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEdldCBtaW5pbXVtIHJhdGluZ1xuICAgICAgICBjb25zdCByYXRpbmdGaWx0ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1maWx0ZXI9XCJyYXRpbmdcIl06Y2hlY2tlZCcpIGFzIEhUTUxJbnB1dEVsZW1lbnQ7XG4gICAgICAgIGlmIChyYXRpbmdGaWx0ZXIpIHtcbiAgICAgICAgICAgIG5ld0ZpbHRlcnMubWluUmF0aW5nID0gcGFyc2VJbnQocmF0aW5nRmlsdGVyLnZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3VycmVudEZpbHRlcnMgPSBuZXdGaWx0ZXJzO1xuICAgICAgICB0aGlzLmFwcGx5RmlsdGVycygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXBwbHlGaWx0ZXJzKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBmaWx0ZXJlZEFnZW50cyA9IHRoaXMuYWdlbnRzLmZpbHRlcihhZ2VudCA9PiB7XG4gICAgICAgICAgICAvLyBDYXRlZ29yeSBmaWx0ZXJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJzLmNhdGVnb3JpZXMubGVuZ3RoICYmIFxuICAgICAgICAgICAgICAgICF0aGlzLmN1cnJlbnRGaWx0ZXJzLmNhdGVnb3JpZXMuaW5jbHVkZXMoYWdlbnQuY2F0ZWdvcnkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBQcmljZSByYW5nZSBmaWx0ZXJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJzLnByaWNlUmFuZ2VzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHByaWNlTWF0Y2ggPSB0aGlzLmN1cnJlbnRGaWx0ZXJzLnByaWNlUmFuZ2VzLnNvbWUocmFuZ2UgPT4gXG4gICAgICAgICAgICAgICAgICAgIGFnZW50LnByaWNlID49IHJhbmdlLm1pbiAmJiBhZ2VudC5wcmljZSA8PSByYW5nZS5tYXhcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmICghcHJpY2VNYXRjaCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBSYXRpbmcgZmlsdGVyXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RmlsdGVycy5taW5SYXRpbmcgPiAwICYmIFxuICAgICAgICAgICAgICAgIGFnZW50LnJhdGluZy5hdmVyYWdlIDwgdGhpcy5jdXJyZW50RmlsdGVycy5taW5SYXRpbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRhZyBmaWx0ZXJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJzLnRhZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWdlbnRUYWdzID0gYWdlbnQudGFncy5tYXAodCA9PiB0LmlkKTtcbiAgICAgICAgICAgICAgICBjb25zdCBoYXNBbGxUYWdzID0gdGhpcy5jdXJyZW50RmlsdGVycy50YWdzLmV2ZXJ5KHRhZyA9PiBcbiAgICAgICAgICAgICAgICAgICAgYWdlbnRUYWdzLmluY2x1ZGVzKHRhZylcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGlmICghaGFzQWxsVGFncykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5yZW5kZXJBZ2VudHMoZmlsdGVyZWRBZ2VudHMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyQWdlbnRzKGFnZW50czogTWFya2V0cGxhY2VBZ2VudFtdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5tYXJrZXRwbGFjZS1ncmlkJyk7XG4gICAgICAgIGlmICghY29udGFpbmVyKSByZXR1cm47XG5cbiAgICAgICAgY29udGFpbmVyLmlubmVySFRNTCA9IGFnZW50cy5tYXAoYWdlbnQgPT4gdGhpcy5jcmVhdGVBZ2VudENhcmQoYWdlbnQpKS5qb2luKCcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUFnZW50Q2FyZChhZ2VudDogTWFya2V0cGxhY2VBZ2VudCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBgXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwiYWdlbnQtY2FyZFwiIGRhdGEtYWdlbnQtaWQ9XCIke2FnZW50LmlkfVwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJyZWxhdGl2ZVwiPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiYWdlbnQtaW1hZ2VcIiBzdHlsZT1cImJhY2tncm91bmQtaW1hZ2U6IHVybCgke2FnZW50LmltYWdlfSlcIj48L2Rpdj5cbiAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJwcmljZS10YWdcIj4kJHthZ2VudC5wcmljZS50b0ZpeGVkKDIpfTwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwicC02IHNwYWNlLXktNFwiPlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1iZXR3ZWVuXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICA8aDMgY2xhc3M9XCJ0ZXh0LWxnIGZvbnQtYm9sZCB0ZXh0LWdyYXktOTAwXCI+JHthZ2VudC5uYW1lfTwvaDM+XG4gICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwicmF0aW5nLXN0YXJzXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLmdlbmVyYXRlU3RhcnMoYWdlbnQucmF0aW5nLmF2ZXJhZ2UpfVxuICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgICA8cCBjbGFzcz1cInRleHQtZ3JheS02MDBcIj4ke2FnZW50LmRlc2NyaXB0aW9ufTwvcD5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImZsZXggZmxleC13cmFwIGdhcC0yXCI+XG4gICAgICAgICAgICAgICAgICAgICAgICAke2FnZW50LnRhZ3MubWFwKHRhZyA9PiBgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJ0YWcgdGFnLSR7dGFnLnR5cGV9XCI+JHt0YWcubmFtZX08L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICAgICBgKS5qb2luKCcnKX1cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9XCJ3LWZ1bGwgYnRuIGJnLWJsdWUtNjAwIHRleHQtd2hpdGUgaG92ZXI6YmctYmx1ZS03MDBcIj5cbiAgICAgICAgICAgICAgICAgICAgICAgIFZpZXcgRGV0YWlsc1xuICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICBgO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVTdGFycyhyYXRpbmc6IG51bWJlcik6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGZ1bGxTdGFycyA9IE1hdGguZmxvb3IocmF0aW5nKTtcbiAgICAgICAgY29uc3QgaGFzSGFsZlN0YXIgPSByYXRpbmcgJSAxID49IDAuNTtcbiAgICAgICAgY29uc3QgZW1wdHlTdGFycyA9IDUgLSBmdWxsU3RhcnMgLSAoaGFzSGFsZlN0YXIgPyAxIDogMCk7XG5cbiAgICAgICAgcmV0dXJuICfimIUnLnJlcGVhdChmdWxsU3RhcnMpICsgXG4gICAgICAgICAgICAgICAoaGFzSGFsZlN0YXIgPyAnwr0nIDogJycpICsgXG4gICAgICAgICAgICAgICAn4piGJy5yZXBlYXQoZW1wdHlTdGFycyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzaG93U29ydE9wdGlvbnMoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHNvcnRPcHRpb25zID0gW1xuICAgICAgICAgICAgeyBsYWJlbDogJ01vc3QgUG9wdWxhcicsIHZhbHVlOiAncG9wdWxhcicgfSxcbiAgICAgICAgICAgIHsgbGFiZWw6ICdIaWdoZXN0IFJhdGVkJywgdmFsdWU6ICdyYXRpbmcnIH0sXG4gICAgICAgICAgICB7IGxhYmVsOiAnTmV3ZXN0JywgdmFsdWU6ICduZXdlc3QnIH0sXG4gICAgICAgICAgICB7IGxhYmVsOiAnUHJpY2U6IExvdyB0byBIaWdoJywgdmFsdWU6ICdwcmljZV9hc2MnIH0sXG4gICAgICAgICAgICB7IGxhYmVsOiAnUHJpY2U6IEhpZ2ggdG8gTG93JywgdmFsdWU6ICdwcmljZV9kZXNjJyB9XG4gICAgICAgIF07XG5cbiAgICAgICAgY29uc3QgbWVudSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBtZW51LmNsYXNzTmFtZSA9ICdhYnNvbHV0ZSByaWdodC0wIG10LTIgdy00OCByb3VuZGVkLW1kIHNoYWRvdy1sZyBiZy13aGl0ZSByaW5nLTEgcmluZy1ibGFjayByaW5nLW9wYWNpdHktNSc7XG4gICAgICAgIG1lbnUuaW5uZXJIVE1MID0gYFxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cInB5LTFcIiByb2xlPVwibWVudVwiPlxuICAgICAgICAgICAgICAgICR7c29ydE9wdGlvbnMubWFwKG9wdGlvbiA9PiBgXG4gICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9XCJibG9jayB3LWZ1bGwgdGV4dC1sZWZ0IHB4LTQgcHktMiB0ZXh0LXNtIHRleHQtZ3JheS03MDAgaG92ZXI6YmctZ3JheS0xMDBcIiBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb2xlPVwibWVudWl0ZW1cIiBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLXNvcnQ9XCIke29wdGlvbi52YWx1ZX1cIj5cbiAgICAgICAgICAgICAgICAgICAgICAgICR7b3B0aW9uLmxhYmVsfVxuICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICBgKS5qb2luKCcnKX1cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICBgO1xuXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVudSk7XG5cbiAgICAgICAgLy8gSGFuZGxlIG9wdGlvbiBzZWxlY3Rpb25cbiAgICAgICAgbWVudS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQXR0cmlidXRlKCdkYXRhLXNvcnQnKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ydEFnZW50cyh0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXNvcnQnKSBhcyBzdHJpbmcpO1xuICAgICAgICAgICAgICAgIG1lbnUucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIENsb3NlIG1lbnUgd2hlbiBjbGlja2luZyBvdXRzaWRlXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgIGlmICghbWVudS5jb250YWlucyhlLnRhcmdldCBhcyBOb2RlKSkge1xuICAgICAgICAgICAgICAgIG1lbnUucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHsgb25jZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNvcnRBZ2VudHMoc29ydEJ5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc29ydGVkQWdlbnRzID0gWy4uLnRoaXMuYWdlbnRzXS5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICBzd2l0Y2ggKHNvcnRCeSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ3BvcHVsYXInOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5zdGF0cy5kb3dubG9hZHMgLSBhLnN0YXRzLmRvd25sb2FkcztcbiAgICAgICAgICAgICAgICBjYXNlICdyYXRpbmcnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYi5yYXRpbmcuYXZlcmFnZSAtIGEucmF0aW5nLmF2ZXJhZ2U7XG4gICAgICAgICAgICAgICAgY2FzZSAnbmV3ZXN0JzpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGIuaWQpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGEuaWQpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBjYXNlICdwcmljZV9hc2MnOlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5wcmljZSAtIGIucHJpY2U7XG4gICAgICAgICAgICAgICAgY2FzZSAncHJpY2VfZGVzYyc6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBiLnByaWNlIC0gYS5wcmljZTtcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5yZW5kZXJBZ2VudHMoc29ydGVkQWdlbnRzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dFcnJvcihtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZXJyb3JEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgZXJyb3JEaXYuY2xhc3NOYW1lID0gJ2ZpeGVkIHRvcC00IHJpZ2h0LTQgYmctcmVkLTEwMCBib3JkZXIgYm9yZGVyLXJlZC00MDAgdGV4dC1yZWQtNzAwIHB4LTQgcHktMyByb3VuZGVkJztcbiAgICAgICAgZXJyb3JEaXYucm9sZSA9ICdhbGVydCc7XG4gICAgICAgIGVycm9yRGl2LmlubmVySFRNTCA9IG1lc3NhZ2U7XG5cbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlcnJvckRpdik7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZXJyb3JEaXYucmVtb3ZlKCksIDUwMDApO1xuICAgIH1cbn1cblxuLy8gSW5pdGlhbGl6ZSBtYXJrZXRwbGFjZSBtYW5hZ2VyXG5jb25zdCBtYXJrZXRwbGFjZU1hbmFnZXIgPSBNYXJrZXRwbGFjZU1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuLy8gRXhwb3J0IGZvciB1c2UgaW4gb3RoZXIgZmlsZXNcbmV4cG9ydCB7IG1hcmtldHBsYWNlTWFuYWdlciwgTWFya2V0cGxhY2VBZ2VudCwgQWdlbnRUYWcsIEFnZW50UmF0aW5nLCBGaWx0ZXJPcHRpb25zIH07XG4iXX0=
export {};
