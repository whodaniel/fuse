<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}';">
    <title>The New Fuse - Communication Hub</title>
    <link rel="stylesheet" href="${styleUri}">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="logo-container">
                <div class="app-logo">üîÑ</div>
                <h1>The New Fuse</h1>
            </div>
            <div class="header-actions">
                <button class="header-button" id="btn-api-keys" title="Configure API Keys">
                    <span class="icon">üîë</span>
                </button>
                <button class="header-button" id="btn-settings" title="Settings">
                    <span class="icon">‚öôÔ∏è</span>
                </button>
                <button class="header-button" id="btn-help" title="Help">
                    <span class="icon">‚ùì</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Quick Actions</h3>
                    <div class="action-list">
                        <button class="action-button" id="btn-discover">
                            <div class="action-icon">üîç</div>
                            <span>Discover AI Agents</span>
                        </button>
                        <button class="action-button" id="btn-collaboration">
                            <div class="action-icon">ü§ù</div>
                            <span>Start AI Collaboration</span>
                        </button>
                        <button class="action-button" id="btn-coding">
                            <div class="action-icon">üíª</div>
                            <span>Collaborative Coding</span>
                        </button>
                        <button class="action-button" id="btn-analyze">
                            <div class="action-icon">üî¨</div>
                            <span>Analyze Code</span>
                        </button>
                        <button class="action-button" id="btn-completion">
                            <div class="action-icon">‚ú®</div>
                            <span>Toggle Completions</span>
                        </button>
                        <button class="action-button" id="btn-model-select">
                            <div class="action-icon">ü§ñ</div>
                            <span>Change AI Model</span>
                        </button>
                        <button class="action-button" id="btn-mcp">
                            <div class="action-icon">üì°</div>
                            <span>MCP Settings</span>
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Active Agents</h3>
                    <div class="agent-list" id="agent-list">
                        <!-- Agent list will be populated dynamically -->
                        <div class="empty-state">
                            <p>No agents discovered yet</p>
                            <button class="secondary-button" id="btn-discover-agents">Discover Agents</button>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>LLM Provider</h3>
                    <div class="provider-selection">
                        <select id="provider-select" class="provider-dropdown">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="vscode">VS Code Built-in</option>
                        </select>
                        <div class="model-selection">
                            <label for="model-select">Model:</label>
                            <select id="model-select" class="model-dropdown">
                                <!-- Will be populated based on selected provider -->
                            </select>
                        </div>
                        <div class="api-key-status" id="api-key-status">
                            API Key: <span id="key-status">Not Configured</span>
                            <button class="small-button" id="btn-configure-api">Configure</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-button active" data-tab="communication">Communication</button>
                        <button class="tab-button" data-tab="agents">Agents</button>
                        <button class="tab-button" data-tab="workflows">Workflows</button>
                        <button class="tab-button" data-tab="logs">Logs</button>
                    </div>

                    <div class="tab-content active" id="communication-tab">
                        <div class="chat-container">
                            <div class="chat-header">
                                <select class="session-dropdown" id="session-dropdown">
                                    <option value="new">New Conversation</option>
                                </select>
                                <button class="header-button" id="btn-clear-chat" title="Clear Chat">
                                    <span class="icon">üóëÔ∏è</span>
                                </button>
                                <button class="header-button" id="btn-export-chat" title="Export Chat">
                                    <span class="icon">üì§</span>
                                </button>
                            </div>

                            <div class="message-list" id="message-list">
                                <div class="welcome-message">
                                    <div class="welcome-logo">üîÑ</div>
                                    <h2>Welcome to The New Fuse Communication Hub</h2>
                                    <p>Coordinate AI extensions and manage inter-agent communication</p>

                                    <div class="welcome-suggestions">
                                        <button class="suggestion-button" id="btn-suggest-discover">
                                            Discover available AI agents in your workspace
                                        </button>
                                        <button class="suggestion-button" id="btn-suggest-collab">
                                            Start a collaborative AI session for your current task
                                        </button>
                                        <button class="suggestion-button" id="btn-suggest-coding">
                                            Get multiple AI perspectives on your code
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="input-area">
                                <div class="input-container">
                                    <textarea class="message-input" id="message-input" placeholder="Type a message to communicate with AI agents..."></textarea>
                                    <button class="send-button" id="send-button" title="Send Message">
                                        <span class="icon">‚û§</span>
                                    </button>
                                </div>

                                <div class="input-actions">
                                    <div class="input-options">
                                        <button class="option-button" id="btn-attach" title="Attach File">
                                            <span class="icon">üìé</span>
                                        </button>
                                        <button class="option-button" id="btn-code" title="Insert Code Block">
                                            <span class="icon">üìù</span>
                                        </button>
                                    </div>

                                    <div class="model-selector">
                                        <span id="active-model">Using: Default AI Model</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="agents-tab">
                        <!-- Agents tab content will be inserted here -->
                        <div class="agents-dashboard">
                            <h2>AI Agent Dashboard</h2>
                            <p>Manage and monitor AI agents in your workspace</p>

                            <div class="agent-cards" id="agent-cards">
                                <!-- Agent cards will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="workflows-tab">
                        <!-- Workflows tab content will be inserted here -->
                        <div class="workflows-dashboard">
                            <h2>AI Workflows</h2>
                            <p>Create and manage AI collaboration workflows</p>

                            <div class="workflow-actions">
                                <button class="primary-button" id="btn-new-workflow">
                                    <span class="icon">‚ûï</span> New Workflow
                                </button>
                                <button class="secondary-button" id="btn-import-workflow">
                                    <span class="icon">üì•</span> Import
                                </button>
                            </div>

                            <div class="workflow-list" id="workflow-list">
                                <!-- Workflow list will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="logs-tab">
                        <!-- Logs tab content will be inserted here -->
                        <div class="logs-dashboard">
                            <h2>Communication Logs</h2>
                            <p>View logs of AI agent communications</p>

                            <div class="log-filters">
                                <select class="log-filter" id="log-level-filter">
                                    <option value="all">All Levels</option>
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                </select>

                                <select class="log-filter" id="log-source-filter">
                                    <option value="all">All Sources</option>
                                    <option value="agent">Agent</option>
                                    <option value="mcp">MCP</option>
                                    <option value="system">System</option>
                                </select>

                                <button class="secondary-button" id="btn-clear-logs">
                                    <span class="icon">üóëÔ∏è</span> Clear Logs
                                </button>
                            </div>

                            <div class="log-entries" id="log-entries">
                                <!-- Log entries will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script nonce="${nonce}" src="${scriptUri}"></script>
    <script>
        (function() {
            // Acquire the VS Code API
            const vscode = acquireVsCodeApi();
            
            // DOM Elements
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const providerSelect = document.getElementById('provider-select');
            const modelSelect = document.getElementById('model-select');
            const apiKeyStatus = document.getElementById('api-key-status');
            const keyStatus = document.getElementById('key-status');
            const configureApiBtn = document.getElementById('btn-configure-api');
            const apiKeysBtn = document.getElementById('btn-api-keys');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const discoverAgentsBtn = document.getElementById('btn-discover-agents');
            const suggestConfigureBtn = document.getElementById('btn-suggest-configure');
            
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
            
            // Open API keys settings
            function openApiSettings() {
                vscode.postMessage({
                    command: 'openSettings'
                });
            }
            
            apiKeysBtn.addEventListener('click', openApiSettings);
            configureApiBtn.addEventListener('click', openApiSettings);
            suggestConfigureBtn.addEventListener('click', openApiSettings);
            
            // Model selection
            providerSelect.addEventListener('change', () => {
                const provider = providerSelect.value;
                vscode.postMessage({
                    command: 'selectProvider',
                    provider: provider
                });
            });
            
            modelSelect.addEventListener('change', () => {
                const model = modelSelect.value;
                vscode.postMessage({
                    command: 'selectModel',
                    model: model
                });
            });
            
            // Message sending
            messageInput.addEventListener('input', () => {
                sendButton.disabled = messageInput.value.trim() === '';
            });
            
            sendButton.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    vscode.postMessage({
                        command: 'sendMessage',
                        message: message
                    });
                    messageInput.value = '';
                    sendButton.disabled = true;
                }
            });
            
            // Discover agents
            discoverAgentsBtn.addEventListener('click', () => {
                vscode.postMessage({
                    command: 'discoverAgents'
                });
            });
            
            document.getElementById('btn-discover').addEventListener('click', () => {
                vscode.postMessage({
                    command: 'discoverAgents'
                });
            });
            
            document.getElementById('btn-model-select').addEventListener('click', () => {
                vscode.postMessage({
                    command: 'openModelSelector'
                });
            });
            
            document.getElementById('btn-suggest-discover').addEventListener('click', () => {
                vscode.postMessage({
                    command: 'discoverAgents'
                });
            });
            
            document.getElementById('btn-suggest-start').addEventListener('click', () => {
                vscode.postMessage({
                    command: 'startConversation'
                });
            });
            
            document.getElementById('btn-suggest-coding').addEventListener('click', () => {
                vscode.postMessage({
                    command: 'getCodeAssistance'
                });
            });
            
            // Message input send on Enter (but allow Shift+Enter for newlines)
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendButton.click();
                }
            });
            
            // Initial API key status and model check
            vscode.postMessage({ command: 'checkApiKeys' });
            vscode.postMessage({ command: 'getCurrentModel' });
            vscode.postMessage({ command: 'getModels' });
            
            // Handle messages from extension
            window.addEventListener('message', (event) => {
                const message = event.data;
                
                switch (message.command) {
                    case 'updateApiKeyStatus':
                        updateApiKeyStatus(message.hasKeys);
                        break;
                    
                    case 'updateProviderModels':
                        updateModelsList(message.provider, message.models, message.currentModel);
                        break;
                    
                    case 'updateCurrentModel':
                        updateCurrentModel(message.provider, message.model);
                        break;
                    
                    case 'addMessage':
                        addMessageToChat(message.message);
                        break;
                }
            });
            
            function updateApiKeyStatus(hasKeys) {
                if (hasKeys) {
                    keyStatus.textContent = 'Configured';
                    keyStatus.style.color = 'var(--vscode-testing-runAction)';
                } else {
                    keyStatus.textContent = 'Not Configured';
                    keyStatus.style.color = 'var(--vscode-errorForeground)';
                }
            }
            
            function updateModelsList(provider, models, currentModel) {
                // Set selected provider
                providerSelect.value = provider;
                
                // Clear and populate model dropdown
                modelSelect.innerHTML = '';
                if (models && models.length) {
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === currentModel) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No models available';
                    modelSelect.appendChild(option);
                }
            }
            
            function updateCurrentModel(provider, model) {
                const activeModelSpan = document.getElementById('active-model');
                if (activeModelSpan) {
                    activeModelSpan.textContent = `Using: ${provider} - ${model}`;
                }
                
                // Try to select this model in the dropdown if it exists
                for (const option of modelSelect.options) {
                    if (option.value === model) {
                        option.selected = true;
                        break;
                    }
                }
            }
            
            function addMessageToChat(message) {
                // Remove welcome message if this is the first message
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                const messageList = document.getElementById('message-list');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.isUser ? 'user-message' : 'ai-message'}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = message.text;
                
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                
                const timestamp = document.createElement('span');
                timestamp.className = 'message-time';
                timestamp.textContent = new Date(message.timestamp || Date.now()).toLocaleTimeString();
                
                messageInfo.appendChild(timestamp);
                messageElement.appendChild(messageContent);
                messageElement.appendChild(messageInfo);
                messageList.appendChild(messageElement);
                
                // Scroll to bottom
                messageList.scrollTop = messageList.scrollHeight;
            }
        })();
    </script>
</body>
</html>
